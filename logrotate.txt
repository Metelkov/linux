Настройка Logrotate  (ubuntu)

(ратировать лог через временной интервал)

в зависимости от дистрибудтива, чтобы поставить, но эта утилита как правило
уже установлена

sudo yum install logrotate
или
sudo apt install logrotate


Все основные настройки программы находятся в файле. 
/etc/logrotate.conf

так же нужно проверить чтобы этот конфиг включал 
строку     include /etc/logrotate.d


файлы с настройками того, что, и как, и сколько нужно ратировать
размещены в папке.
/etc/logroate.d/


т.е. там несколько файлов, 1 файл - 1 сервис и если нам нужно чтобы наш лог
ратировался - создаем в этой папке файл и называем его понятным именем.
файл без расширений.  но нужно проверить, чтобы основной конфиг включал
папку /etc/logroate.d/


вот пример двух стандартных конфигов для ротации:

root@backupubuntu:/mnt/backup#  cat /etc/logrotate.d/alternatives
/var/log/alternatives.log {
        monthly
        rotate 12
        compress
        delaycompress
        missingok
        notifempty
        create 644 root root
}

и

root@backupubuntu:/mnt/backup#  cat /etc/logrotate.d/apt
/var/log/apt/term.log {
  rotate 12
  monthly
  compress
  missingok
  notifempty
}

/var/log/apt/history.log {
  rotate 12
  monthly
  compress
  missingok
  notifempty
}



Каждый лог, который подлежит ротации описывается таким образом:

адрес_файла_лога {
директивы
}



Сначала давайте рассмотрим основные директивы, которые мы будем применять во время настройки. 
Здесь директивы выглядят не совсем обычно, сама директива и определяет что и когда нужно делать,
а уже если нужно, ей передаются дополнительные параметры. Чтобы указать как часто нужно выполнять 
проверку совпадению условий используются такие директивы:

hourly - каждый час;
daily - каждый день;
weekly - каждую неделю;
monthly - каждый месяц;
yearly - каждый год.


Основные директивы управления и обработки логов:
rotate - указывает сколько старых логов нужно хранить, в параметрах передается количество;
create - указывает, что необходимо создать пустой лог файл после перемещения старого;
dateext - добавляет дату ротации перед заголовком старого лога;
compress - указывает, что лог необходимо сжимать;
delaycompress - не сжимать последний и предпоследний журнал;
extension - сохранять оригинальный лог файл после ротации, если у него указанное расширение;
mail - отправлять Email после завершения ротации;
maxage - выполнять ротацию журналов, если они старше, чем указано;
missingok - не выдавать ошибки, если лог файла не существует;
olddir - перемещать старые логи в отдельную папку;
postrotate/endscript - выполнить произвольные команды после ротации;
start - номер, с которого будет начата нумерация старых логов;
size - размер лога, когда он будет перемещен;




Теперь давайте создадим файл rsyslog.conf в папке /etc/logrotate.d/ и поместим в него настройки для ротации этого лога:

/var/log/messages {
daily
rotate 3
size 10M
compress
delaycompress
}


Эти настройки означают, что ротация журналов будет выполняться ежедневно, и мы будем хранить три последних журнала, более старые копии будут автоматически удаляться. Минимальный размер для ротации - 10 мегабайт, ротация не будет выполнена, если лог не занимает более 10 мегабайт. Будет использоваться сжатие, для всех журналов кроме последнего и предпоследнего. Точно по такому же принципу вы можете настроить ротацию логов для любого из журналов. Нужно создать такую секцию для каждого из логов, которыми вы хотите управлять.


Теперь осталось протестировать как работает наша конфигурация. Для этого запустим утилиту logrotate с опцией -d. Она выведет все, что планируется сделать, но не будет изменять файлы на диске. У нас есть файл /var/log/messages, размером 40 Мегабайт, посмотрим что будет делать утилита:

logrotate -d /etc/logrotate.d/rsyslog.conf



Как видите, программа обнаруживает файл лога и разделяет его на несколько частей. Вы можете убедиться, что logrotate будет запускаться как положено проверив расписание cron:

 ls /etc/cron.daily/



