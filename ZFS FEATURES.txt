ZFS FEATURES
(разработчики добовляют особенности без требования полного пересбора пула)

все делаем на DEBIAN

для виртуалок - использовать BIOS
для реального железа - lagacy support

нужно 2 жестких диска одного объема не менее 8 Гб

zpool list --смотрит какие zfs пулы есть


смотреть все параметры пула
zpool get all zp0    --zp0 имя нашего пула

особенность 
enable -значит что особенность есть, но она сейчас не выполняется
cative - используется

lz4_compress - сжатие на лету

обновляемся с 7 ветки (v 0.7) до 8 (v 0.8)

смотрим версии  и тут же покажет мудули
gpkg -l | grep zfs


но т.к. у нас это ститемный пул - нам нужно перезагрузиться, но перед 
перезагрузкой нужно выполнить
update-initramfs -u -k all

теперь обновляем:
1. подключаем новый функционал (новые особенности после обновления) к
нашему пулу (так, постпенно обновлять все пулы которые требуют обновлений)
переводим "особенности" в состояние enabled

zpool upgrade zp0

-a   --все пулы, которые импортированы в систему д.будут обновиться
zp0 --или указать наименование пула в котором хотим сделать обновление - этот
вариант предпочтительнее, т.к. не везде есть необходимость подключать новые
особенности


проверяем (еще раз выполняем команды которые делались автоматически):

устанавливаем grub на загрузочный диск
grub-install /dev/vda   --/dev/vda наш диск, без разделов, только диск
(если дисков много, например есть raid - то делаем поочериди для всех)

обновим ramfs
update-initramfs -u -k -all  --обновляем для всех ядер

обновляем grub
update-grub

-------
включим шифрование
/mnt/encription   --наша папка, где мы все шифруем

zfs create -o encription=aes-256-gcm -o keylocation=prompt -o keyformat=passphrase -o mountpoint=/mnt/encription zp0/debian/encription

create   --создаем новый data set
-o encription=aes-256-gcm  --включит шифрование и выбор алгоритма шифрования
-o keylocation=prompt  --указываем, что парольная фраза вводится с клавиатуры
-o keyformat=passphrase --указывается что будет парольная фраза (можно и ключ)
-o mountpoint=/mnt/encription --куда подмонтируем
zp0/debian/encription  --наш data set

сейчас у нас просят пароль - нужно ввести

можно посмотреть наш data set
zfs list -r zp0


можно посмотреть куда смонтирована
df -h


---------
если включена "особенность" которая не позволяет grub выполнять загрузку
1. грузимся с системы, которая поддерживает zfs той же версии
(например live cd ubuntu 20.04)

создаем каталог, куда импортируем наш старый (который сломали) пул, zp0 например

дальше импортируем
zpool inport -R /mnt/zp0 zp0  --последний zp0 имя нашего пула

-R  --altroot - значит, что все точки монтирования, которые присутствуют
в этом пуле должны будут смонтироваться со смещением относительно этого
каталога, например /mnt/zp0//mnt/encription  -двойная черта

получим ошибку, что zp0 уже был в другой операционной системе
и если мы все же хотим его импортировать нужен флаг -f

zpool inport -R /mnt/zp0 zp0 -f

проверим, что пул импортировался
zpool list

проверяем наши "особенности" на наличие active

удаляем (предвариательно скопировав) dataset который активирует эту "особенность"
zfs destroy zp0/dibian/encription

после удаления "особенность" encription переходит из action в enabled

перезагружаемся
в нашу систему
но может возникнуть ошибка, что пул необходимо импортировать с параметром -f
в initramfs выполняем 
zpool import -N zp0 -f    (это должно быть на экране)

после импорта выходим
exit

