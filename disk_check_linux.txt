			ПРОВЕРКА ДИСКОВ LINUX

Важно! Запуск и выполнение FSCK на смонтированной файловой системе может привести к повреждению данных - размонтируйте раздел

В некоторых случаях, когда диск системный, нужно перейти в однопользовательский режим (Single user mode) и размонтировать файловую систему.
или загрузить компьютер в режиме восстановления с помощью установочного компакт-диска (live-cd)

1) Single user mode
Измените уровень инициализации и размонтируйте файловую систему:
# init 1
# umount /home

Выполните поиск подключенных разделов:
# fdisk -l

После этого запустите FSCK для раздела с ошибками:
# fsck /dev/sda1

2) Режим восстановления с установочного компакт-диска
Вставьте установочный компакт-диск в дисковод и перезагрузите систему:
Подождите некоторое время и после загрузки с установочного компакт-диска выполните команду:
# linux rescue nomount

Директива NOMOUNT запретит монтирование, так что вы сможете безопасно использовать FSCK.

После этого запустите FSCK для раздела с ошибками:
# fsck -yvf /dev/sda1

-y   автоматическое (без запросов) исправление ошибок
-f   принудительная проверка файловой системы
-v   подробный вывод на экран

-p   для автоматического устранения любых проблем, которые будут безопасно устранены без вмешательства пользователя
-C   Отображает индикатор выполнения
-l   Блокирует устройство
-r   Отображает статистику для каждого проверенного устройства


По факту выполнения FSCK вернет результат в виде кода, данный код — это уникальный номер, представляющей сумму следующих значений:
0 — Без ошибок (No errors);
1 — Исправлены ошибки файловой системы (Filesystem errors corrected);
2 — Система должна быть перезагружена (System should be rebooted);
4 — Ошибки файловой системы оставили без изменений (Filesystem errors left uncorrected);
8 — Эксплуатационная ошибка (Operational error);
16 — Ошибки при использовании или синтаксические ошибки (Usage or syntax error);
32 — Fsck отменен по запросу пользователя (Fsck canceled by user request);
128 — Ошибка общей библиотеки (Shared-library error).



*******     Исправление ошибки корневой файловой системы      *********
Поскольку корневая система не может быть отключена, Fsck не может проверять наличие ошибок. Но у вас есть возможность запустить 
fsck в режиме восстановления. Перезагрузив компьютер в режиме аварийного восстановления, вы можете запустить fsck. Чтобы 
запустить fsck для исправления ошибок файлов корневой системы, выполнив следующие действия.

Войдите в меню загрузки и выберите «Дополнительные параметры»  (Advanced Options).
Теперь выберите “Режим восстановления” (Recovery mode), а затем в меню выберите» fsck”

Далее появится окно сообщения с вопросом, хотите ли вы переустановить свою / файловую систему. Выберите опцию "Да"

Далее окно с Продолжить с перемонтированием файловой системы...
нажмите «ДА» и вернитесь к нормальной загрузке
опсле выбираем resume   -resume normal boot



----  Проверка и исправление диска LVM без шифрования с помощью fdisk -----

Для начала проверяем разметку дисков с lsblk:
lsblk

Пример вывода:
 NAME                 MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
 sda                    8:0    0    20G  0 disk  
 └─sda1                 8:1    0    20G  0 part  
   └─xubuntu--vg-root 253:0    0    19G  0 lvm   / 
 sr0                   11:0    1  1024M  0 rom

***** в нашем случае ******
sda                        8:0    0 931,5G  0 disk
├─sda1                     8:1    0   512M  0 part /boot/efi
├─sda2                     8:2    0     2G  0 part [SWAP]
├─sda3                     8:3    0     2G  0 part
└─sda4                     8:4    0   927G  0 part
sdb                        8:16   0   1,8T  0 disk
└─sdb1                     8:17   0   1,8T  0 part
  └─backupdisks-copydisk 253:0    0   3,7T  0 lvm
sdc                        8:32   0   1,8T  0 disk
└─sdc1                     8:33   0   1,8T  0 part
  └─backupdisks-copydisk 253:0    0   3,7T  0 lvm



Как можно увидеть, LVM назван xubuntu--vg-root (в нашем случае backupdisks-copydisk), но мы не можем запустить fsck на это имя, так 
как команда не найдёт его. Нам нужно получить полное имя, для этого нужно запустить команду lvm lvscan для получения LV 
имени с которым мы можем запустить fsck на LVM.

lvscan
Пример вывода:
inactive          '/dev/xubuntu-vg/root' [<19.04 GiB] inherit
inactive          '/dev/xubuntu-vg/swap_1' [980.00 MiB] inherit

****** в нашем случае *****
lvscan
  ACTIVE            '/dev/backupdisks/copydisk' [<3,64 TiB] inherit
root@backupubuntu:/home/metelkov# fsck -yfv /dev/backupdisks/copydisk


Как можно увидеть, имя диска который нужно проврить на ошибки это /dev/xubuntu-vg/root (у нас /dev/backupdisks/copydisk), оно должно 
подойти для запуска fsck на этом имя.

Если /dev/xubuntu-vg/root не ACTIVE (у нас сразу активный), нужно сделать его активным чтобы мы могли запустить его проверку.

lvchange -ay /dev/xubuntu-vg/root

*****у нас ******
lvchange -ay /dev/backupdisks/copydisk

Теперь это должно выглядеть примерно так:

lvscan
   ACTIVE            '/dev/xubuntu-vg/root' [<19.04 GiB] inherit
   inactive          '/dev/xubuntu-vg/swap_1' [980.00 MiB] inherit

****** у нас ******
lvscan
  ACTIVE            '/dev/backupdisks/copydisk' [<3,64 TiB] inherit


перед проверкой нужно отмонтировать устройство
umount /dev/backupdisks/copydisk


Теперь можно запустить fsck для проверку тома LVM:

fsck /dev/xubuntu-vg/root

***** в нашем случае *****
мы запускаем проверку с ключами
-y   автоматическое (без запросов) исправление ошибок
-f   принудительная проверка файловой системы
-v   подробный вывод на экран

-p   для автоматического устранения любых проблем, которые будут безопасно устранены без вмешательства пользователя
-C   Отображает индикатор выполнения
-l   Блокирует устройство
-r   Отображает статистику для каждого проверенного устройства


fsck -yfv /dev/backupdisks/copydisk


--------------------------------------------
*********      Исправление LVM с шифрованием       ************
Может так быть, что действия из предыдущего примера возможны только при нормальной загрузке системы, когда доступны все возможные утилиты. 
Соответственно, в Emergency mode указанные операции не удастся выполнить

Поэтому рассмотрим пример восстановления системы с Live образа. Причина анализируемой проблемы в том, что apt autoremove удалила пакет 
cryptsetup и другие важные для расшифровки и нормальной работы раздела утилиты. Это привело к тому, что система перестала 
загружаться (из-за того, что корневой раздел не может быть смонтирован и расшифрован используя LVM).

Если вы не используете LVM и полнодисковое шифрование, то дальнейшее возможно вам не подходит.

В данном примере удалось исправить систему и переустановить cryptsetup и lvm2 в окружении chroot: для этого понадобилось загрузиться с 
флешки Live USB, запустить последующие команды в терминале и перезагрузиться

Поиск корневого раздела:
sudo fdisk -l

Расшифровываем раздел.
sudo cryptsetup open --type luks /dev/nvme0n1p3 nvme0n1p3_crypt

Внимание:
замените /dev/nvme0n1p3 на ваш собственный диск
замените "nvme0n1p3_crypt" на корректное имя раздела для вашей установки, вы можете его узнать запустив следующее в chroot:

cat /etc/crypttab | cut -f1 -d " "
Пример вывода:

nvme0n1p3_crypt

Монтирование корневого раздела
sudo vgscan
sudo vgchange -ay
sudo mount /dev/mapper/xubuntu--vg-root /mnt

Подготовка окружения chroot:
sudo mount /dev/nvme0n1p2 /mnt/boot/ # замените nvme0n1p2 на ваш загрузочный раздел!
sudo mount -o rbind /dev/ /mnt/dev/
sudo mount -t proc proc /mnt/proc/
sudo mount -t sysfs sys /mnt/sys/

Делаем так, чтобы в chroot работал DNS:
sudo cp /etc/resolv.conf /mnt/etc/resolv.conf

Входим в chroot:
sudo chroot /mnt /bin/bash

Переустанавливаем отсутствующие пакеты:
apt install cryptsetup lvm2

Заново генерируем (это может быть выполнено командой apt на предыдущем шаге — если это уже было сделано, то пропустите):
update-initramfs -u -k all

Покидаем среду chroot:
exit

Записываем буфер на диск:
sudo sync

Размантируем файловые системы:
sudo umount /mnt/sys
sudo umount /mnt/proc
sudo umount /mnt/boot


