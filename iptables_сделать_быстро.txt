      iptables                      (от 2023.08.22)  как сделать быстро (тут мало теории, см другой файл - теория и основы)

DROP, заставит удаленную машину думать, что наш узел в данный момент вообще отсутствует в сети
REJECT, позволит удаленному узлу понять, что пакет был отброшен из-за правил межсетевого экрана
(iptables -I INPUT -p tcp --dport 22 -m state --state NEW -j ACCEPT)


----БЛОКИРОВКА ОТДЕЛЬНОГО ПОРТА----
Ограничение доступа к определенному порту:
Использовать следующий синтаксис для блокировки определенного IP-адреса:
    iptables -A INPUT -s "IP-ADDRESS" -p tcp --dport "port_number" -j DROP


Например, чтобы заблокировать IP-адрес 192.168.10.5 только на порту 100, используйте следующую команду:
    iptables -A INPUT -s 192.168.10.5 -p tcp --dport 100 -j DROP



----БЛОКИРОВАКА АДРЕСА----
Для блокирования IP адреса используются действия DROP и REJECT. Рассмотрим общий синтаксис действия по блокированию.
sudo iptables [-t таблица] -A [цепочка] -s [IP адрес/маска] -d [IP адрес/маска] -j [действие]
Опции утилиты:
-s [IP адрес/маска] - IP адрес источника пакета, к которому мы хотим применить действие;
-d [IP адрес/маска] - IP адрес получателя пакета, к которому мы хотим применить действие.


запретить ip, iptables блокирует все входящие на защищаемую машину пакеты от узла, с IP адресом 8.8.8.8. 
    iptables -t filter -A INPUT -s 8.8.8.8/32 -j DROP


Заблокировать доступ КО ВСЕМ ПОРТАМ
Использование блочного порта iptables может предотвратить доступ IP-адреса к вашему серверу.
    iptables -A INPUT -s IP-ADDRESS -j DROP

Например, следующая команда ПОЛНОСТЬЮ ЗАБЛОКИРУЕТ IP-адрес 192.168.10.5:
    iptables -A INPUT -s 192.168.10.5 -j DROP



Есть второе действие для блокирования всех пакетов от конкретного узла или к конкретному узлу - это REJECT.
Данное действие предусматривает при блокировании пакета отправку служебной информации источнику пакета о выполнении блокировки. 
То есть в данном случае узел отправитель будет уведомлен, что пакет был заблокирован Netfilter.

чтобы заблокировать ip iptables надо выполнить:
    iptables -t filter -A INPUT -s 8.8.8.8/32 -j REJECT



Следует отметить, что, как в случае с портами, существует возможность БЛОКИРОВАНИЯ ИСХОДЯЩЕГО ТРАФИКА и входящего трафика. 
То есть, если мы хотим ЗАБЛОКИРОВАТЬ ДОСТУП КОНКРЕТНОГО УЗЛА (К НАМ ИЗ ИНТЕРНЕТА) сети к нашей машине, то мы блокируем входящий трафик:
    iptables -t filter -A INPUT -s 8.8.4.4/32 -j REJECT


Если же мы захотим заблокировать доступ нашего компьютера К КОНКРЕТНОМУ УЗЛУ (ОТ НАС, НАПРИМЕР HH.RU) в сети, например, Интернет, 
то мы БЛОКИРУЕМ ИСХОДЯЩИЙ ТРАФИК:
    iptables -t filter -A OUTPUT -d 8.8.8.8/32 -j REJECT



----БЛОКИРОВАКА ПОДСЕТИ----
 Как заблокировать подсеть iptables?
Подсеть - это строго ограниченная часть всего пространства IP адресов. Подсеть задается маской. Маска может быть задана в виде четырех, разделенных точками, чисел или в виде одного числа. Например: 255.255.255.0 - это маска посети, и /24 - маска подсети.
Отметим только, что все множество адресов IPv4 разбито на сети, сети имеют классы, которые задают количество адресов в сетях, и их практическое назначение. А сети, в свою очередь разбиваются на подсети, для отдельных организаций и частных лиц. И сеть, и подсеть задаются с помощью маски сети. Теперь давайте рассмотрим как забанить диапазон ip адресов iptables.


если мы хотим заблокировать доступ к конкретной организации, подмножество адресов которой мы знаем, мы сделаем это с помощью известного нам адреса сети (подсети) и маски. Правило блокировки будет выглядеть следующим образом:
В данном случае мы заблокировали подсеть адресов диапазона 8.0.0.0 - 8.127.255.255. 
    iptables -t filter -A INPUT -s 8.0.0.0/9 -j DROP


Другой вариант маски будет выглядеть так:
    iptables -t filter -A INPUT -s 8.0.0.0/255.128.0.0 -j DROP

Например, это правило блокирует сеть, выданную европейскому региону (см классы адресов и их принадлеж к регионам):
    iptables -t filter -A INPUT -s 2.0.0.0/255.0.0.0 -j DROP




----БЛОКИРОВКА НА СЕТЕВОМ ИНТЕРФЕЙСЕ----
Как заблокировать IP сетевом интерфейсе?
Бывают случаи, когда в защищаемом устройстве присутствуют несколько сетевых интерфейсов, подключенных к разным сетям, или к одной сети, но разными путями (протоколами, маршрутами, организациями). В таком случае часто бывает нужна блокировка ip iptables с определенного интерфейса. Правило блокирования в этом случае будет выглядеть так:

Для входящего сетевого интерфейса:
    iptables [-t таблица] -A INPUT -i [имя интерфейса входа] -s [IP адрес/маска] -d [IP адрес/маска] -j [действие]


Для исходящего сетевого интерфейса. В частном случае входящий и исходящий интерфейс один и тот же.
    iptables [-t таблица] -A OUTPUT -o [имя интерфейса выхода] -s [IP адрес/маска] -d [IP адрес/маска] -j [действие]


Например, чтобы заблокировать все пакеты от IP адреса 8.8.8.8, поступающие нам с интерфейса enp0s3, можно использовать правило:
    iptables -t filter -A INPUT -i enp0s3 -s 8.8.8.8/32 -j DROP

Чтобы заблокировать все пакеты, уходящие к машине с IP адресом 8.8.8.8, с нашего узла через интерфейс enp0s3 следует использовать правило:
    iptables -t filter -A OUTPUT -o enp0s3 -d 8.8.8.8/32 -j DROP



Как запретить ping через iptables
Цифра 8 означает, что речь идёт об эхо-запросе. Список возможных типов можно посмотреть командой iptables -p icmp -h

ограничить ICMP-пакеты:
iptables -A INPUT -p icmp --icmp-type 8 -j DROP

Разрешить ping хоста тоже очень просто. Команда будет выглядеть так:
iptables -A INPUT -p icmp --icmp-type 8 -j ACCEPT



----РАЗБЛОКИРОВКА----
Как разблокировать IP адрес?
По умолчанию в межсетевом экране Netfilters используется действие ACCEPT для всех таблиц и цепочек. 

(разрешим порт 22)
iptables -I INPUT -p tcp --dport 22 -m state --state NEW -j ACCEPT

//Также для того, чтобы ограничить доступ к компьютеру более строго, мы можем заменить правило по умолчанию ACCEPT на правило DROP или REJECT с помощью команды
//sudo iptables -t [таблица] -P [цепочка] [действие]
//Например, следующая команда установит правило по умолчанию для таблицы filter цепочки INPUT действие по умолчанию -отбрасывать пакеты:
//sudo iptables -t filter -P INPUT DROP


В таком случае, ЧТОБЫ РАЗБЛОКИРОВАТЬ IP iptables адрес, необходимо будет задать правило для данного IP адреса с действием ACCEPT:
    тут не сработало
    iptables -t filter -A INPUT -i enp0s3 -s 8.8.8.8/32 -j ACCEPT

    а это сработало
    iptables -I INPUT -s 8.8.8.8/32 -j ACCEPT


Разрешаем весь входящий трафик, кроме трафика с узла с IP-адресом 192.168.3.2:
iptables -A INPUT -s 192.168.3.2 -j DROP
iptables -P INPUT ACCEPT


----УДАЛЕНИЕ ПРАВИЛ----
Удалите правило DROP.
Если вы хотите удалить правило, добавленное на предыдущем шаге, используйте команду iptables drop:
sudo iptables -D INPUT -s 192.168.10.5 -j DROP 
sudo iptables -D INPUT -s 192.168.10.5 -p tcp --destination-port 100 -j DROP



---ОТОБРАЖЕНИЕ ПРАВИЛ----
Следующая команда отобразит ограниченный IP-адрес и порт:
Следующая команда отобразит IP-адрес из черного списка:
sudo iptables -L





----СОХРАНЕНИЕ ПРАВИЛ----
Сохранить правило iptables

В CentOS/RHEL/Fedora используйте следующую команду, чтобы сохранить правило iptables:
    service iptables save

В Ubuntu/Debian вы должны настроить пакет iptables-persistent в своей системе Ubuntu/Debian. Чтобы установить и настроить iptables-persistent, выполните следующую команду:
sudo apt-get update -y && apt-get install iptables-persistent -y

После установки используйте следующую команду, чтобы сохранить правило iptables (для ubuntu):
    service netfilter-persistent save

ИЛИ  iptables-save
выдаст такое:
# Generated by iptables-save v1.8.4 on Tue Aug 22 14:52:38 2023
*filter
:INPUT ACCEPT [41954:3073955]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [43227:3336960]
COMMIT


